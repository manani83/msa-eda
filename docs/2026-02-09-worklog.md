# 2026-02-09 작업 기록

## 요약
- 프로젝트를 Gradle 멀티모듈 구조(`app`, `order`, `coupon`)로 전환.
- 소스/테스트/리소스를 각 모듈 디렉터리로 이동하고 모듈별 `build.gradle` 추가.
- 루트 `build.gradle`, `settings.gradle`을 멀티모듈에 맞게 정리.
- `order` 모듈 테스트를 위해 Spring Boot 테스트 전용 설정을 추가하고 테스트를 수정.
- `./gradlew test` 실행 완료.

## 주요 변경 사항
- 멀티모듈 구조
  - 모듈: `app`, `order`, `coupon`
  - 루트 include: `app`, `order`, `coupon`
- `order` 테스트 조정
  - `OrderTestApplication`, `OrderIntegrationTestApplication` 추가.
  - `OrderControllerTest`를 SpringBootTest + MockMvc 방식으로 수정하고 테스트 예외 핸들러를 import.

## 테스트
- 명령어: `./gradlew test`
- 결과: 성공

## 메모
- IntelliJ에서는 모듈 내부 소스가 패키지 트리로 보이지만, Gradle 기준으로는 멀티모듈 구조임.

## 추가 진행 (MySQL 전환)
- H2 의존성 제거 및 MySQL 커넥터 추가.
- `application.yml`을 MySQL 접속 설정으로 변경하고 `data.sql` 초기화 유지.
- `docker-compose.yml`로 로컬 MySQL 실행 구성 추가.
- 테스트는 Testcontainers(MySQL) 사용으로 전환.
- `order` 테스트에 Testcontainers 설정 주입.

## 추가 진행 (테스트 MySQL)
- `app` 모듈 테스트에 Testcontainers(MySQL) 적용.
- `GreetingRecordPersistenceAdapterTest`에서 embedded DB 대체 비활성화.
- `spring-boot-testcontainers` 의존성 추가.
- `app` 테스트에서 `data.sql` 실행을 비활성화.
- `app` 테스트에서 JPA ddl-auto를 create-drop으로 설정.
- MySQL에서 `data.sql`가 스키마 생성 이후 실행되도록 `defer-datasource-initialization` 추가.
- MySQL 호환을 위해 주문 시퀀스 초기화 쿼리를 `ON DUPLICATE KEY UPDATE`로 변경.

## 실행
- `docker compose up -d` 실행 (MySQL 컨테이너 기동).
- `./gradlew test` 재실행: 성공(종료 시 MySQL 연결 해제 관련 경고 로그 발생).

## 추가 진행 (테스트 스키마/데이터 초기화 정리)
- 테스트에서 JPA `create-drop` + `data.sql` 자동 실행 방식으로 정리.
- `app` 테스트는 `data-test.sql`만 실행하도록 분리.
- 테스트 종료 시점 DROP을 피하기 위해 테스트용 ddl-auto를 create로 변경.

## 추가 진행 (로컬 실행 스크립트)
- `scripts/dev-up.sh`: docker compose 기동 후 `:app:bootRun` 실행.
- `scripts/dev-down.sh`: docker compose 종료.
- `dev-up.sh` 종료 시 `docker compose down` 자동 실행(trap 추가).
- `dev-up.sh`에서 자동 down 동작 제거.
- dev-up에서 `SPRING_PID_FILE=build/app.pid`로 PID 파일 생성.
- dev-down에서 PID 파일 기반으로 Spring Boot 프로세스 종료 후 docker compose down 실행.
- data.sql 중복 실행 시 오류 방지를 위해 `ON DUPLICATE KEY UPDATE`로 변경.
- dev-up PID 파일 경로를 `app/build/app.pid`로 고정하고 쓰기 실패 시 에러로 처리.
- dev-down: PID 파일 없으면 `HexagonalApiApplication` 프로세스를 pgrep로 종료하는 fallback 추가.
- dev-up: bootRun을 백그라운드로 실행하고 로그를 `app/build/bootRun.log`로 기록.
- dev-up: /hello 엔드포인트로 헬스체크 추가(최대 60초 대기).
